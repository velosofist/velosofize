// This project uses Leaflet.js (BSD 2-Clause License)

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Velosofize KML Visualizer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
      .material-symbols-outlined {
        font-variation-settings:
          'FILL' 0,
          'wght' 600,
          'GRAD' 0,
          'opsz' 24;
        font-size: 16px;
        color: #e6e5e1; /* Customize icon color */
      }
      body { margin: 0; padding: 0; font-family: sans-serif; }
      #map { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
      #project-header {
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(8, 12, 59, 0.9);
        padding: 6px 12px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 8px;
        color: white;
        font-size: 24px;
        font-family: sans-serif;
      }
      #project-header img {
        width: 24px;
        height: 24px;
        border-radius: 4px;
      }

      #link-buttons {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(8, 12, 59, 0.9);
        padding: 6px 6px;
        border-radius: 8px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: flex;
        flex-direction: column; /* Change layout to vertical */
        gap: 8px; /* Add spacing between buttons */
      }
      #link-buttons a {
        display: inline-block;
        width: 32px;
        height: 32px;
        background: rgba(8, 12, 59, 0.9);
        border-radius: 50%;
        text-align: center;
        line-height: 40px;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
      }
      #link-buttons a:hover {
        transform: scale(1.15);
      }
      #link-buttons a img {
        width: 30px;
        height: 30px;
        vertical-align: middle;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <button id="legend-btn" title="CyclOSM Legend"
      style="
        position: fixed;
        top: 16px;
        right: 16px;
        z-index: 2000;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #08103b;
        color: #fff;
        font-size: 22px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      ">
      <span class="material-symbols-outlined" style="font-size: 28px;">help</span>
    </button>

    <div id="legend-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.55); z-index:3000; align-items:center; justify-content:center;">
      <div style="position:relative; width:90vw; max-width:600px; height:90vh; background:#fff; border-radius:12px; box-shadow:0 4px 32px rgba(0,0,0,0.3); overflow:hidden;">
        <button id="close-legend" title="Затвори / Close"
          style="position:absolute; top:12px; right:16px; z-index:10; background:#08103b; color:#fff; border:none; border-radius:50%; width:32px; height:32px; font-size:20px; cursor:pointer;">
          <span class="material-symbols-outlined" style="font-size: 16px;">close</span>
        </button>
        <iframe src="./cyclosm_legend.html" style="width:100%; height:100%; border:none;"></iframe>
      </div>
    </div>

    <div id="project-header">
      <a href="https://velosofist.github.io/velosofize/index.html"
        style="text-decoration:none; color:#e6e5e1; display:flex; align-items:center; gap:8px;">
        <img
          src="https://velosofist.github.io/velosofize/attachments/temp_icon.jpeg"
          alt="Velosofize Icon">
        <span>VELOSOFIZE</span>
      </a>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script
      src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

    <div id="link-buttons">
      <a href="https://www.google.com/maps/d/u/0/edit?mid=13Ke06MOSLTuBBbr2ITKNV7kLhs_v2Qc&usp=sharing"
        target="_blank" title="Google Maps">
        <img
          src="https://www.gstatic.com/marketing-cms/assets/images/48/6b/6a951c294a47991a8229779b508e/maps.webp=s108-fcrop64=1,00000000ffffffff-rw"
          alt="Google Maps">
      </a>
      <a href="https://earth.google.com/web/@42.68536362,23.34252187,551.21893103a,13559.28278408d,35y,-0h,0t,0r/data=CgRCAggBMigKJgokCiAxM0tlMDZNT1NMVHVCQmJyMklUS05WN2tMaHNfdjJRYyACOgMKATBCAggASggI3rfSkgMQAQ"
        target="_blank" title="Google Earth">
        <img
          src="https://www.gstatic.com/marketing-cms/assets/images/32/80/489eca5d4dfab22aa3901c6c882a/g-earth.webp=s108-fcrop64=1,00000000ffffffff-rw"
          alt="Google Earth">
      </a>
      <a href="https://github.com/velosofist/velosofize/tree/main/export_formats"
        target="_blank" title="GitHub">
        <img
          src="https://raw.githubusercontent.com/velosofist/velosofize/refs/heads/main/attachments/github-mark/github-mark-white.png"
          alt="GitHub">
        </a>
    </div>

    <div id="overlay-toggle-buttons"
      style="
        position: absolute;
        right: 16px;
        bottom: 150px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 8px;
        background: rgba(8,12,59,0.9);
        border: 1px solid #e6e5e1;
        border-radius: 12px;
        padding: 8px;
        box-sizing: border-box;
        ">
    </div>

    <div id="layer-switcher"
      style="
        position: absolute;
        bottom: 16px;
        right: 16px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid #e6e5e1;
        border-radius: 12px;
        background: rgba(8,12,59,0.9);
        padding: 10px 8px;
        ">
      <span style="color: #e6e5e1; font-weight: bold; margin-bottom: 6px; font-size: 16px;">
        Основа
      </span>
      <button id="layer-icon-btn"
        style="background: rgba(8,12,59,0.9); border: none; border-radius: 8px; padding: 0; cursor: pointer;">
        <img id="layer-icon-img" src="tile_icons/tile_cyclosm.png" alt="CyclOSM" style="width: 60px; height: 60px;">
      </button>
    </div>

    <div id="layer-name-flash"
      style="
        display: none;
        position: fixed;
        bottom: 16px;
        width: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(8,12,59,0.95);
        color: #fff;
        font-weight: bold; 
        font-size: 16px;
        text-align: center;
        padding: 12px 32px;
        border-radius: 12px;
        z-index: 3000;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.5s;
      ">
    </div>

    <script>
      // const map = L.map('map').setView([42.685534, 23.319048], 13);
      const map = L.map('map', {
        center: [42.685534, 23.319048],
        zoom: 13,
        zoomControl: false
      });

      document.getElementById('legend-btn').onclick = function() {
        document.getElementById('legend-overlay').style.display = 'flex';
      };
      document.getElementById('close-legend').onclick = function() {
        document.getElementById('legend-overlay').style.display = 'none';
      };
      // Optional: close overlay when clicking outside the modal
      document.getElementById('legend-overlay').onclick = function(e) {
        if (e.target === this) this.style.display = 'none';
      };

      // Add zoom control manually in a different position
      L.control.zoom({
        position: 'bottomleft'
      }).addTo(map);
    
      const layers = {
        cyclosm: L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
          attribution: '&copy; CyclOSM, OpenStreetMap contributors'
        }),
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }),
        esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          attribution: '&copy; Esri, Earthstar Geographics'
        })
      };
    
      const layerOrder = [
        { name: 'cyclosm', icon: 'tile_icons/tile_cyclosm.png', alt: 'CyclOSM' },
        { name: 'osm',     icon: 'tile_icons/tile_osm.png',     alt: 'OpenStreetMap' },
        { name: 'esri',    icon: 'tile_icons/tile_sat.png',     alt: 'Satellite' }
      ];
      let currentLayerIdx = 0;

      function updateLayerIcon() {
        const { icon, alt } = layerOrder[currentLayerIdx];
        document.getElementById('layer-icon-img').src = icon;
        document.getElementById('layer-icon-img').alt = alt;
      }

      document.getElementById('layer-icon-btn').onclick = function() {
        // Cycle to next layer
        currentLayerIdx = (currentLayerIdx + 1) % layerOrder.length;
        setBaseLayer(layerOrder[currentLayerIdx].name);
        updateLayerIcon();
      };

      // Ensure icon matches current layer on load
      updateLayerIcon();

      // Default base layer
      layers.cyclosm.addTo(map);
      let currentBaseLayer = layers.cyclosm;
    
      const layerFlashNames = {
        cyclosm: "CyclOSM",
        osm: "OpenStreetMap",
        esri: "Satellite"
      };

      function flashLayerName(layerKey) {
        const flashDiv = document.getElementById('layer-name-flash');
        flashDiv.textContent = layerFlashNames[layerKey] || '';
        flashDiv.style.display = 'block';
        flashDiv.style.opacity = '0.8';

        // Force reflow to restart the transition if called rapidly
        void flashDiv.offsetWidth;

        setTimeout(() => {
          flashDiv.style.opacity = '0';
          setTimeout(() => {
            flashDiv.style.display = 'none';
          }, 500); // Hide after fade out
        }, 500); // Show for 0.7s before starting fade out
      }

      // Example: Call this in your setBaseLayer function
      function setBaseLayer(layerName) {
        if (layers[layerName] && currentBaseLayer !== layers[layerName]) {
          map.removeLayer(currentBaseLayer);
          map.addLayer(layers[layerName]);
          currentBaseLayer = layers[layerName];
          flashLayerName(layerName);
        }
      }
    
      const mapOverlayFilesInit = [
        'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/velosofize_export.kml',
        // 'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/transport.kml',
      ];

      const mapOverlayFilesToggled = [
        {
          url: 'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/transport.kml',
          label: 'Транспорт / Transport',
          icon: 'train'
        },
        {
          url: 'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/crossings.kml',
          label: 'Кръстовища / Crossings',
          icon: 'directions_walk'
        },
        {
          url: 'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/slow_zones.kml',
          label: 'Бавни зони / Slow zones',
          icon: '30fps'
        },
        {
          url: 'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/others.kml',
          label: 'Други / Others',
          icon: 'quiz'
        },
      ];

      const overlayLayers = {};

      const overlayToggleDiv = document.getElementById('overlay-toggle-buttons');
      mapOverlayFilesToggled.forEach(({url, label, icon}) => {

        // Create the overlay but don't add to map yet
        const overlay = createStyledOverlay(url);
        overlayLayers[url] = overlay;

        // Create the toggle button
        const btn = document.createElement('button');
        btn.title = label; // Show label on hover
        btn.innerHTML = `<span class="material-symbols-outlined" style="font-size: 28px;">${icon}</span>`;

        // Style the button
        btn.style.margin = '0 4px';
        btn.style.padding = '4px 4px';
        btn.style.fontSize = '14px';
        btn.style.cursor = 'pointer';
        btn.style.border = 'none';
        btn.style.background = '#08103b';
        btn.style.color = '#08103b';
        btn.style.borderRadius = '4px';
        btn.dataset.active = 'false';

        btn.onclick = function() {
          if (btn.dataset.active === 'false') {
            overlay.addTo(map);
            btn.style.background = '#0074D9';
            btn.style.color = '#fff';
            btn.dataset.active = 'true';
          } else {
            map.removeLayer(overlay);
            btn.style.background = '#08103b';
            btn.style.color = '#08103b';
            btn.dataset.active = 'false';
          }
        };

        overlayToggleDiv.appendChild(btn);
      });


      

      function styleFromStyleUrl(styleUrl, featureWeight) {
        const match = styleUrl?.match(/#line-([0-9A-Fa-f]{6})/);
        if (match) {
          return {
            color: `#${match[1]}`,
            weight: featureWeight,
            opacity: 1
          };
        } else {
          return {
            color: "#0074D9", // grey by default
            weight: featureWeight,
            opacity: 0.8
          };
        }
      }

      function colorFromStyleUrl(styleUrl) {
        const match = styleUrl?.match(/#(?:icon-\d+-)?([0-9A-Fa-f]{6})/);
        return match ? `#${match[1]}` : "#CCCCCC";
      }

      function pointToLayer(feature, latlng) {
        const styleUrl = feature.properties?.styleUrl;
        const fillColor = colorFromStyleUrl(styleUrl);
        
        // Extract the relevant style (ignoring everything after the second '-')
        const relevantStyle = styleUrl?.split('-')[1]?.split('-')[0];

        // Mapping of relevant styles to Material Symbols icon names
        const iconMapping = {
          '1589': 'fitness_center',
          '1877': 'stairs_2',
          '1833': 'directions_walk',
          '1718': 'tram',
          '1716': 'train',
          '1703': 'water_bottle',
        };

        // Default to 'question_mark' if no match is found
        const iconName = iconMapping[relevantStyle] || 'question_mark';

        // Create a combined divIcon with both the circle and the Material Symbols icon
        const combinedIconHtml = `
          <div style="position: relative; width: 24px; height: 24px;">
            <div style="width: 22px; height: 22px; border-radius: 50%; background-color: ${fillColor}; opacity: 0.8; border: 1px solid white;"></div>
            <span class="material-symbols-outlined" style="position: absolute; top: 4px; left: 4px; font-size: 16px; color: #e6e5e1;">${iconName}</span>
          </div>
        `;

        const iconSizePx = 24
        const combinedDivIcon = L.divIcon({
          className: 'custom-combined-icon',
          html: combinedIconHtml,
          iconSize: [iconSizePx, iconSizePx], // Adjust size as needed
          iconAnchor: [iconSizePx/2, iconSizePx/2] // Center the icon
        });

        // Create a marker with the combined icon
        return L.marker(latlng, { icon: combinedDivIcon });
      }

      function createStyledOverlay(url) {
        return omnivore.kml(url, null, L.geoJson(null, {
          style: function(feature) {
            const styleUrl = feature.properties?.styleUrl;

            // Determine weight based on feature type
            let featureWeight;
            if (feature.geometry?.type === 'Point') {
              featureWeight = 1;
            } else if (feature.geometry?.type === 'LineString') {
              featureWeight = 4;
            } else if (feature.geometry?.type === 'Polygon') {
              featureWeight = 0;
            }

            return styleFromStyleUrl(styleUrl, featureWeight);
          },
          pointToLayer: pointToLayer,
          onEachFeature: interactivePoints
        }));
      }

      mapOverlayFilesInit.forEach((url) => {
        createStyledOverlay(url).addTo(map);
      });



      

      function interactivePoints(feature, layer) {
        // Make only points interactive
        if (feature.geometry?.type === 'Point') {
          if (feature.properties?.description) {
            layer.bindPopup(`
              <div style="
                position: relative;
                background: #fff;
                border-radius: 8px;
                padding: 16px 24px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.12);
                margin-bottom: 16px;
                max-width: 320px;
              ">
                <strong>${feature.properties.name}</strong>
              </div>

              <button style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                border: none;
                background: #e6e5e1;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                box-shadow: 0 2px 6px rgba(0,0,0,0.08);
              ">
                <span class="material-symbols-outlined" style="font-size: 20px; color: #444;">link</span>
              </button> 
            `);
          }
          if (feature.properties?.name) {
            layer.bindPopup(`
              <strong>${feature.properties.name}</strong>
            `)
          }
        }
      }



      const markers = [];
      let line = null;
      let popup = null;

      function addLabeledMarker(latlng) {
        if (markers.length >= 2) return;

        const label = markers.length === 0 ? 'A' : 'B';

        const marker = L.marker(latlng, {
          draggable: true,
          title: label,
        }).addTo(map);

        marker.bindTooltip(label, { permanent: true, direction: 'top' }).openTooltip();

        // Remove marker on click
        marker.on('click', () => {
          map.removeLayer(marker);
          const index = markers.indexOf(marker);
          if (index !== -1) {
            markers.splice(index, 1);
            updateLabels();
            updateLine();
          }
        });

        marker.on('drag', updateLine); // update line if marker moves

        markers.push(marker);
        updateLine();
      }

      function updateLabels() {
        markers.forEach((marker, idx) => {
          const newLabel = idx === 0 ? 'A' : 'B';
          marker.setTooltipContent(newLabel);
        });
      }

      function updateLine() {
        // Remove existing line and popup
        if (line) {
          map.removeLayer(line);
          line = null;
        }
        if (popup) {
          map.removeLayer(popup);
          popup = null;
        }

        if (markers.length === 2) {
          const latlngs = [markers[0].getLatLng(), markers[1].getLatLng()];
          line = L.polyline(latlngs, { color: 'blue', weight: 3, dashArray: '5, 10' }).addTo(map);

          const midLat = (latlngs[0].lat + latlngs[1].lat) / 2;
          const midLng = (latlngs[0].lng + latlngs[1].lng) / 2;
          const midpoint = L.latLng(midLat, midLng);

          // const gmapsIcon = 'https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg';
          const gmapsIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://maps.google.com';
          const urlGmapsAB = `https://www.google.com/maps/dir/?api=1&origin=${latlngs[0].lat},${latlngs[0].lng}&destination=${latlngs[1].lat},${latlngs[1].lng}&travelmode=walking`;
          const urlGmapsBA = `https://www.google.com/maps/dir/?api=1&origin=${latlngs[1].lat},${latlngs[1].lng}&destination=${latlngs[0].lat},${latlngs[0].lng}&travelmode=walking`;
          
          // const moovitIcon = 'https://play-lh.googleusercontent.com/xsU7mWsfvM6ZFRWi6R3FSukXBRDRaOeKJH-_Y1uPyZvGPM6O2_azLBCh2Ymc4qV4MVg'; 
          const moovitIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://moovitapp.com/'; 
          const urlMoovitAB = `https://moovitapp.com/tripplan/sofia_%D1%81%D0%BE%D1%84%D0%B8%D1%8F-3501/en?ref=12&lang=en&fll=${latlngs[0].lat}_${latlngs[0].lng}&tll=${latlngs[1].lat}_${latlngs[1].lng}`;
          const urlMoovitBA = `https://moovitapp.com/tripplan/sofia_%D1%81%D0%BE%D1%84%D0%B8%D1%8F-3501/en?ref=12&lang=en&fll=${latlngs[1].lat}_${latlngs[1].lng}&tll=${latlngs[0].lat}_${latlngs[0].lng}`;
          
          const orsIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://cyclosm.org/';
          const urlOrsAB = `https://maps.openrouteservice.org/directions?n1=${latlngs[0].lat}&n2=${latlngs[0].lng}&n3=14&a=${latlngs[0].lat},${latlngs[0].lng},${latlngs[1].lat},${latlngs[1].lng}&b=1&c=0&k1=en-US&k2=km`;
          const urlOrsBA = `https://maps.openrouteservice.org/directions?n1=${latlngs[1].lat}&n2=${latlngs[1].lng}&n3=14&a=${latlngs[1].lat},${latlngs[1].lng},${latlngs[0].lat},${latlngs[0].lng}&b=1&c=0&k1=en-US&k2=km`;

          const popupHtml = `
            <div style="text-align:center;">
              <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
              <a style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left; font-weight:bold; color:black;">
                Moovit
              </a>
              <a href="${urlMoovitAB}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
                <img src="${moovitIcon}" style="width:16px;">
                A → B
              </a>
              <a href="${urlMoovitBA}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
                <img src="${moovitIcon}" style="width:16px;">
                B → A
              </a>
              
              <a style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left; font-weight:bold; color:black;">
                OpenRouteService
              </a>
              <a href="${urlOrsAB}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
                <img src="${orsIcon}" style="width:16px;">
                A → B
              </a>
              <a href="${urlOrsBA}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
                <img src="${orsIcon}" style="width:16px;">
                B → A
              </a>
            </div>
          `;

          popup = L.popup({ closeButton: false, autoClose: false })
            .setLatLng(midpoint)
            .setContent(popupHtml)
            .addTo(map);
        }
      }

      map.on('contextmenu', e => addLabeledMarker(e.latlng));
  </script>
  </body>
</html>