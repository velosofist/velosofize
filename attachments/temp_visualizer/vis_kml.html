<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Velosofize KML Visualizer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: sans-serif; }
    #map { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
    
    #project-header {
    position: absolute;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(8, 12, 59, 0.9);
    padding: 6px 12px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    color: white;
    font-size: 24px;
    font-family: sans-serif;
    }

    #project-header img {
      width: 24px;
      height: 24px;
      border-radius: 4px;
    }
    
    #layer-buttons {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(8, 12, 59, 0.9);
      padding: 6px 6px;
      border-radius: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #layer-buttons button {
      margin: 0 4px;
      padding: 4px 4px;
      font-size: 14px;
      cursor: pointer;
    }

    #link-buttons {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(8, 12, 59, 0.9);
    padding: 6px 6px;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    gap: 8px;
  }

  #link-buttons a {
    display: inline-block;
    width: 40px;
    height: 40px;
    background: rgba(8, 12, 59, 0.9);
    border-radius: 50%;
    text-align: center;
    line-height: 40px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    transition: transform 0.2s;
  }
  
  #link-buttons a:hover {
    transform: scale(1.1);
  }

  #link-buttons a img {
    width: 24px;
    height: 24px;
    vertical-align: middle;
  }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="project-header">
    <a href="https://velosofist.github.io/velosofize/index.html" style="text-decoration:none; color:white; display:flex; align-items:center; gap:8px;">
      <img src="https://velosofist.github.io/velosofize/attachments/temp_icon.jpeg" alt="Velosofize Icon">
      <span>VELOSOFIZE</span>
    </a>
  </div>

  <div id="layer-buttons">
    <button onclick="setBaseLayer('cyclosm')">CyclOSM</button>
    <button onclick="setBaseLayer('osm')">OpenStreetMap</button>
    <button onclick="setBaseLayer('esri')">Satellite</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore/leaflet-omnivore.min.js"></script>

  <div id="link-buttons">
    <a href="https://www.google.com/maps/d/u/0/edit?mid=13Ke06MOSLTuBBbr2ITKNV7kLhs_v2Qc&usp=sharing" target="_blank" title="Google Maps">
      <img src="https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg" alt="Google Maps">
    </a>
    <a href="https://earth.google.com/web/@42.68536362,23.34252187,551.21893103a,13559.28278408d,35y,-0h,0t,0r/data=CgRCAggBMigKJgokCiAxM0tlMDZNT1NMVHVCQmJyMklUS05WN2tMaHNfdjJRYyACOgMKATBCAggASggI3rfSkgMQAQ" target="_blank" title="Google Earth">
      <img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Google_Earth_icon.svg" alt="Google Earth">
    </a>
  </div>

  <div id="layer-buttons">
    <button onclick="setBaseLayer('cyclosm')">CyclOSM</button>
    <button onclick="setBaseLayer('osm')">OpenStreetMap</button>
    <button onclick="setBaseLayer('esri')">Satellite</button>
  </div>

  <script>
    const map = L.map('map').setView([42.685534, 23.319048], 13);
  
    const layers = {
      cyclosm: L.tileLayer('https://{s}.tile-cyclosm.openstreetmap.fr/cyclosm/{z}/{x}/{y}.png', {
        attribution: '&copy; CyclOSM, OpenStreetMap contributors'
      }),
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }),
      esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri, Earthstar Geographics'
      })
    };
  
    // Default base layer
    layers.cyclosm.addTo(map);
    let currentBaseLayer = layers.cyclosm;
  
    function setBaseLayer(layerName) {
      if (layers[layerName] && currentBaseLayer !== layers[layerName]) {
        map.removeLayer(currentBaseLayer);
        map.addLayer(layers[layerName]);
        currentBaseLayer = layers[layerName];
      }
    }
  
    // Array of KML file URLs
    const kmlFiles = [
      'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/velosofize_export.kml',
      'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/transport.kml',
      'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/others.kml',
      'https://raw.githubusercontent.com/velosofist/velosofize/main/export_formats/.ignore/crossings.kml'
    ];
  
    function styleFromStyleUrl(styleUrl) {
      const match = styleUrl?.match(/#line-([0-9A-Fa-f]{6})/);
      if (match) {
        return {
          color: `#${match[1]}`,
          weight: 4,
          opacity: 1
        };
      } else {
        return {
          color: "#0074D9",
          weight: 3,
          opacity: 0.8
        };
      }
    }
  
    // Loop through the KML files and add them to the map
    kmlFiles.forEach((kmlUrl) => {
      omnivore.kml(kmlUrl, null, L.geoJson(null, {
        style: function(feature) {
          const styleUrl = feature.properties?.styleUrl;
          return styleFromStyleUrl(styleUrl);
        },
        onEachFeature: function(feature, layer) {
          let popupContent = "";
  
          if (feature.properties) {
            if (feature.properties.name) {
              popupContent += `<strong>${feature.properties.name}</strong><br>`;
            }
            if (feature.properties.description) {
              popupContent += `${feature.properties.description}<br>`;
            }
  
            // Show other properties if available
            for (let key in feature.properties) {
              if (key !== "name" && key !== "description" && key !== "styleUrl" && key !== "styleHash" && key !== "Категория #") {
                popupContent += `<strong>${key}:</strong> ${feature.properties[key]}<br>`;
              }
            }
          }
  
          if (popupContent) {
            layer.bindPopup(popupContent);
          }
        }
      })).addTo(map);
    });

  const markers = [];
  let line = null;
  let popup = null;

  function addLabeledMarker(latlng) {
    if (markers.length >= 2) return;

    const label = markers.length === 0 ? 'A' : 'B';

    const marker = L.marker(latlng, {
      draggable: true,
      title: label,
    }).addTo(map);

    marker.bindTooltip(label, { permanent: true, direction: 'top' }).openTooltip();

    // Remove marker on click
    marker.on('click', () => {
      map.removeLayer(marker);
      const index = markers.indexOf(marker);
      if (index !== -1) {
        markers.splice(index, 1);
        updateLabels();
        updateLine();
      }
    });

    marker.on('drag', updateLine); // update line if marker moves

    markers.push(marker);
    updateLine();
  }

  function updateLabels() {
    markers.forEach((marker, idx) => {
      const newLabel = idx === 0 ? 'A' : 'B';
      marker.setTooltipContent(newLabel);
    });
  }

  function updateLine() {
    // Remove existing line and popup
    if (line) {
      map.removeLayer(line);
      line = null;
    }
    if (popup) {
      map.removeLayer(popup);
      popup = null;
    }

    if (markers.length === 2) {
      const latlngs = [markers[0].getLatLng(), markers[1].getLatLng()];
      line = L.polyline(latlngs, { color: 'blue', weight: 3, dashArray: '5, 10' }).addTo(map);

      const midLat = (latlngs[0].lat + latlngs[1].lat) / 2;
      const midLng = (latlngs[0].lng + latlngs[1].lng) / 2;
      const midpoint = L.latLng(midLat, midLng);

      // const gmapsIcon = 'https://upload.wikimedia.org/wikipedia/commons/a/aa/Google_Maps_icon_%282020%29.svg';
      const gmapsIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://maps.google.com';
      const urlGmapsAB = `https://www.google.com/maps/dir/?api=1&origin=${latlngs[0].lat},${latlngs[0].lng}&destination=${latlngs[1].lat},${latlngs[1].lng}&travelmode=walking`;
      const urlGmapsBA = `https://www.google.com/maps/dir/?api=1&origin=${latlngs[1].lat},${latlngs[1].lng}&destination=${latlngs[0].lat},${latlngs[0].lng}&travelmode=walking`;
      
      // const moovitIcon = 'https://play-lh.googleusercontent.com/xsU7mWsfvM6ZFRWi6R3FSukXBRDRaOeKJH-_Y1uPyZvGPM6O2_azLBCh2Ymc4qV4MVg'; 
      const moovitIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://moovitapp.com/'; 
      const urlMoovitAB = `https://moovitapp.com/tripplan/sofia_%D1%81%D0%BE%D1%84%D0%B8%D1%8F-3501/en?ref=12&lang=en&fll=${latlngs[0].lat}_${latlngs[0].lng}&tll=${latlngs[1].lat}_${latlngs[1].lng}`;
      const urlMoovitBA = `https://moovitapp.com/tripplan/sofia_%D1%81%D0%BE%D1%84%D0%B8%D1%8F-3501/en?ref=12&lang=en&fll=${latlngs[1].lat}_${latlngs[1].lng}&tll=${latlngs[0].lat}_${latlngs[0].lng}`;
      
      const orsIcon = 'https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://cyclosm.org/';
      const urlOrsAB = `https://maps.openrouteservice.org/directions?n1=${latlngs[0].lat}&n2=${latlngs[0].lng}&n3=14&a=${latlngs[0].lat},${latlngs[0].lng},${latlngs[1].lat},${latlngs[1].lng}&b=1&c=0&k1=en-US&k2=km`;
      const urlOrsBA = `https://maps.openrouteservice.org/directions?n1=${latlngs[1].lat}&n2=${latlngs[1].lng}&n3=14&a=${latlngs[1].lat},${latlngs[1].lng},${latlngs[0].lat},${latlngs[0].lng}&b=1&c=0&k1=en-US&k2=km`;

      const popupHtml = `
        <div style="text-align:center;">
          <a style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left; font-weight:bold; color:black;">
            Google Maps
          </a>
          <a href="${urlGmapsAB}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${gmapsIcon}" style="width:16px;">
            A → B
          </a>
          <a href="${urlGmapsBA}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${gmapsIcon}" style="width:16px;">
            B → A
          </a>

          <a style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left; font-weight:bold; color:black;">
            Moovit
          </a>
          <a href="${urlMoovitAB}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${moovitIcon}" style="width:16px;">
            A → B
          </a>
          <a href="${urlMoovitBA}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${moovitIcon}" style="width:16px;">
            B → A
          </a>
          
          <a style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left; font-weight:bold; color:black;">
            OpenRouteService
          </a>
          <a href="${urlOrsAB}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${orsIcon}" style="width:16px;">
            A → B
          </a>
          <a href="${urlOrsBA}" target="_blank" style="text-decoration:none; display:flex; align-items:left; gap:6px; margin:4px; justify-content:left;">
            <img src="${orsIcon}" style="width:16px;">
            B → A
          </a>
        </div>
      `;

      popup = L.popup({ closeButton: false, autoClose: false })
        .setLatLng(midpoint)
        .setContent(popupHtml)
        .addTo(map);
    }
  }

  map.on('contextmenu', e => addLabeledMarker(e.latlng));
  </script>
</body>
</html>